<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ALCPT Preparation Program</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 30px;
      max-width: 700px;
      width: 100%;
    }
    h2 {
      margin: 0;
      font-size: 1.6rem;
      text-align: center;
      font-weight: 600;
      color: #111;
    }
    p.subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 20px;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #007aff;
    }
    button {
      display: inline-block;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      margin-top: 18px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    #writeBtn {
      background: #34c759;
      color: white;
      margin-right: 10px;
    }
    #writeBtn:hover {
      background: #28a745;
    }
    #recordBtn {
      background: #e5e5ea;
      color: #111;
    }
    #recordBtn.recording {
      background: #ff3b30;
      color: white;
    }
    #liveTranscript {
      margin-top: 10px;
      font-style: italic;
      color: #666;
      text-align: center;
    }
    h3 {
      margin-top: 30px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #111;
    }
    .info-box, .result-box {
      background: #f2f2f7;
      padding: 15px;
      border-radius: 12px;
      font-size: 14px;
      color: #111;
      margin-top: 10px;
    }
    .progress-bar {
      background: #e5e5ea;
      border-radius: 6px;
      overflow: hidden;
      height: 16px;
      margin-top: 8px;
    }
    .progress {
      background: #007aff;
      height: 100%;
      color: white;
      text-align: center;
      font-size: 12px;
      line-height: 16px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ALCPT Preparation Program</h2>
    <p class="subtitle">Grammar Checker ‚Äì Level 2</p>

    <label for="learnerId">Learner ID (required)</label>
    <input type="number" id="learnerId" placeholder="Enter your ID (numbers only)" required />

    <label for="grammarPoint">Select Grammar Point (required)</label>
    <select id="grammarPoint" required>
      <option value="">-- Select a Grammar Point --</option>
    </select>
    <div id="grammarInfo" class="info-box" style="display:none;"></div>

    <label for="sentence">Your Sentence</label>
    <textarea id="sentence" rows="3" placeholder="Type your sentence here..."></textarea>

    <div>
      <button id="writeBtn">Check Writing</button>
      <button id="recordBtn">üé§ Start Recording</button>
    </div>
    <div id="liveTranscript"></div>

    <h3>Result</h3>
    <div id="resultBox" class="result-box">No check yet.</div>
  </div>

  <script>
    const grammarPointSelect = document.getElementById("grammarPoint");
    const grammarInfo = document.getElementById("grammarInfo");
    const resultBox = document.getElementById("resultBox");
    const liveTranscript = document.getElementById("liveTranscript");
    const backendUrl = "https://alcpt-grammar-checker.onrender.com"; // replace with your Render backend URL
    let grammarPoints = [];

    // Load grammar points
    fetch(`${backendUrl}/api/grammar-points`)
      .then(res => res.json())
      .then(points => {
        grammarPoints = points;
        points.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.id}. ${p.title}`;
          grammarPointSelect.appendChild(opt);
        });
      });

    // Show description + example when grammar point is selected
    grammarPointSelect.addEventListener("change", () => {
      const gp = grammarPoints.find(p => String(p.id) === grammarPointSelect.value);
      if (gp) {
        grammarInfo.style.display = "block";
        grammarInfo.innerHTML = `<strong>${gp.title}</strong><br>
        <em>Rule:</em> ${gp.rule}<br>
        <em>Example:</em> ${gp.example}`;
      } else {
        grammarInfo.style.display = "none";
      }
    });

    // Format result
    function renderResult(data, grammarId) {
      if (data.error) {
        resultBox.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
        return;
      }

      resultBox.innerHTML = `
        <p><strong>Original:</strong> ${data.transcript || ""}</p>
        <p><strong>Corrected:</strong> <span style="color:${data.grammar_ok ? 'green':'red'};">${data.corrected || ""}</span></p>
        <p><strong>Explanation:</strong> ${data.explanation || ""}</p>
        <p><strong>Matched Grammar Point:</strong> ${data.matched_grammar_label || "N/A"}</p>
        <p><strong>Score:</strong> ${data.score || 0}%</p>
        <div class="progress-bar">
          <div class="progress" style="width:${data.score || 0}%">${data.score || 0}%</div>
        </div>
      `;
    }

    // Writing check
    document.getElementById("writeBtn").addEventListener("click", async () => {
      const learnerId = document.getElementById("learnerId").value.trim();
      const grammarId = grammarPointSelect.value;
      const sentence = document.getElementById("sentence").value;

      if (!learnerId) {
        alert("Learner ID is required.");
        return;
      }
      if (!grammarId) {
        alert("Please select a grammar point.");
        return;
      }
      if (!sentence) {
        alert("Please type a sentence first!");
        return;
      }

      const formData = new FormData();
      formData.append("learner_id", learnerId);
      formData.append("grammar_id", grammarId);
      formData.append("typed", sentence);

      const res = await fetch(`${backendUrl}/api/text`, { method: "POST", body: formData });
      const data = await res.json();
      renderResult(data, grammarId);
    });

    // Recording logic
    let mediaRecorder, audioChunks = [], isRecording = false;

    document.getElementById("recordBtn").addEventListener("click", async () => {
      const learnerId = document.getElementById("learnerId").value.trim();
      const grammarId = grammarPointSelect.value;

      if (!learnerId) {
        alert("Learner ID is required.");
        return;
      }
      if (!grammarId) {
        alert("Please select a grammar point.");
        return;
      }

      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const formData = new FormData();
          formData.append("learner_id", learnerId);
          formData.append("grammar_id", grammarId);
          formData.append("audio", audioBlob, "recording.webm");

          const res = await fetch(`${backendUrl}/api/grammar`, { method: "POST", body: formData });
          const data = await res.json();
          renderResult(data, grammarId);
          liveTranscript.textContent = "";
        };

        mediaRecorder.start();
        isRecording = true;
        document.getElementById("recordBtn").textContent = "‚èπ Stop Recording";
        document.getElementById("recordBtn").classList.add("recording");
        liveTranscript.textContent = "üéô Listening...";
      } else {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById("recordBtn").textContent = "üé§ Start Recording";
        document.getElementById("recordBtn").classList.remove("recording");
      }
    });
  </script>
</body>
</html>

